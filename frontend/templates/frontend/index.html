<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* frontend/static/frontend/css/styles.css */
        body {
            background-color: #212529;
            color: #e9ecef;
        }

        .card {
            background-color: #343a40;
            color: #e9ecef;
            border: 1px solid #495057;
        }

        .form-control, .form-select {
            background-color: #495057 !important;
            color: #e9ecef !important;
            border-color: #6c757d;
        }

        .file-list-item {
            transition: background-color 0.2s;
            border-left: 5px solid #17a2b8;
            background-color: #343a40;
            color: #e9ecef;
        }

        .file-list-item:hover {
            background-color: #3d444b;
        }

        #auth-container { 
            max-width: 500px; 
            margin-top: 50px; 
        }

        #admin-controls {
            border: 2px solid #ffc107;
            background-color: #495057;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <a href="userView.html">stronka g≈Ç√≥wna</a>
    <div id="auth-screen" class="container">
        <div id="auth-container" class="card p-4 mx-auto">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="login-tab" data-bs-toggle="tab" href="#login-pane">Logowanie</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="register-tab" data-bs-toggle="tab" href="#register-pane">Rejestracja</a>
                </li>
            </ul>
            <div class="tab-content mt-3">
                <div class="tab-pane fade show active" id="login-pane">
                    <h3>Zaloguj siƒô</h3>
                    <div class="mb-3">
                        <label for="login-username" class="form-label">Nazwa u≈ºytkownika</label>
                        <input type="text" class="form-control" id="login-username" placeholder="Wpisz nazwƒô u≈ºytkownika">
                    </div>
                    <div class="mb-3">
                        <label for="login-password" class="form-label">Has≈Ço</label>
                        <input type="password" class="form-control" id="login-password" placeholder="Wpisz has≈Ço">
                    </div>
                    <button class="btn btn-primary w-100" onclick="login()">Zaloguj</button>
                    <div id="login-error" class="text-danger mt-3"></div>
                </div>
                <div class="tab-pane fade" id="register-pane">
                    <h3>Zarejestruj siƒô</h3>
                    <div class="mb-3">
                        <label for="reg-username" class="form-label">Nazwa u≈ºytkownika</label>
                        <input type="text" class="form-control" id="reg-username" placeholder="Nowa nazwa u≈ºytkownika">
                    </div>
                    <div class="mb-3">
                        <label for="reg-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="reg-email" placeholder="Tw√≥j email">
                    </div>
                    <div class="mb-3">
                        <label for="reg-password" class="form-label">Has≈Ço</label>
                        <input type="password" class="form-control" id="reg-password" placeholder="Ustaw has≈Ço">
                    </div>
                    <button class="btn btn-success w-100" onclick="registerUser()">Zarejestruj</button>
                    <div id="register-error" class="text-danger mt-3"></div>
                    <div id="register-success" class="text-success mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboard-screen" class="container mt-5 d-none">
        <nav class="navbar navbar-dark bg-dark mb-4">
            <div class="container-fluid">
                <span class="navbar-brand">üóÇÔ∏è File Manager</span>
                <div>
                    <span id="username-display" class="navbar-text me-3"></span>
                    <button id="logout-btn" class="btn btn-outline-light btn-sm" onclick="logout()">Wyloguj</button>
                </div>
            </div>
        </nav>

        <div id="admin-dashboard" class="d-none">
            <div id="admin-controls">
                <h4 class="text-warning mb-3">‚öôÔ∏è Panel Administratora</h4>
                <div class="row">
                    <div class="col-md-6">
                        <label for="user-filter" class="form-label">Filtruj pliki u≈ºytkownika:</label>
                        <input type="text" id="user-filter" class="form-control" placeholder="Wpisz nazwƒô u≈ºytkownika" onchange="loadFiles()">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Sortowanie:</label>
                        <select id="sort-select" class="form-select" onchange="loadFiles()">
                            <option value="-uploaded_at">Najnowsze</option>
                            <option value="uploaded_at">Najstarsze</option>
                            <option value="original_filename">Nazwa A-Z</option>
                            <option value="-original_filename">Nazwa Z-A</option>
                            <option value="-file_size">Rozmiar (malejƒÖco)</option>
                            <option value="file_size">Rozmiar (rosnƒÖco)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="card p-4">
            <h3>üì§ Wgraj nowe pliki</h3>
            <div class="mb-3">
                <label for="file-input" class="form-label">Wybierz pliki (mo≈ºesz wybraƒá wiele):</label>
                <input type="file" class="form-control" id="file-input" multiple>
                <small class="text-muted">Wybrano plik√≥w: <span id="file-count">0</span></small>
            </div>
            <div class="mb-3">
                <label for="file-description" class="form-label">Opis (opcjonalnie, wsp√≥lny dla wszystkich):</label>
                <textarea class="form-control" id="file-description" rows="2" placeholder="Dodaj kr√≥tki opis..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="uploadFiles()">Wgraj pliki</button>
            <div id="upload-status" class="mt-3"></div>
        </div>

        <div class="card p-4 mt-4">
            <h3>üìÅ Pliki <small id="files-owner-info" class="text-muted"></small></h3>
            <div id="loading-files" class="text-center d-none">
                <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">≈Åadowanie...</span>
                </div>
            </div>
            <div id="no-files-msg" class="alert alert-info d-none">Brak plik√≥w do wy≈õwietlenia.</div>
            <div id="file-list"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- INICJALIZACJA PAMIƒòCI ---
        let accessToken = localStorage.getItem('access_token');
        let refreshToken = localStorage.getItem('refresh_token');
        let currentUsername = '';
        let isAdmin = false;

        // --- NARZƒòDZIA OG√ìLNE ---
        function getAuthHeaders(contentType = 'application/json') {
            const headers = {
                'Authorization': `Bearer ${accessToken}`
            };
            if (contentType) {
                headers['Content-Type'] = contentType;
            }
            return headers;
        }

        function decodeToken(token) {
            const payload = JSON.parse(atob(token.split('.')[1]));
            currentUsername = payload.username;
            isAdmin = payload.is_staff || payload.is_superuser || false;
        }

        function toggleView(isLoggedIn) {
            document.getElementById('auth-screen').classList.toggle('d-none', isLoggedIn);
            const dashboard = document.getElementById('dashboard-screen');
            dashboard.classList.toggle('d-none', !isLoggedIn);
            document.getElementById('logout-btn').classList.toggle('d-none', !isLoggedIn);
            document.getElementById('username-display').classList.toggle('d-none', !isLoggedIn);
            
            if (isLoggedIn) {
                document.getElementById('username-display').textContent = `Witaj, ${currentUsername}! ${isAdmin ? '(ADMIN)' : ''}`;
                document.getElementById('admin-dashboard').classList.toggle('d-none', !isAdmin);
                loadFiles();
            } else {
                currentUsername = '';
                isAdmin = false;
                document.getElementById('username-display').textContent = '';
            }
        }

        // --- LOGIKA UWIERZYTELNIANIA I JWT ---
        async function login() {
            const data = {
                username: document.getElementById('login-username').value,
                password: document.getElementById('login-password').value
            };
            const errorElement = document.getElementById('login-error');
            errorElement.textContent = '';

            try {
                const response = await fetch('/api/users/token/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const tokenData = await response.json();
                    accessToken = tokenData.access;
                    refreshToken = tokenData.refresh;
                    localStorage.setItem('access_token', accessToken);
                    localStorage.setItem('refresh_token', refreshToken);
                    decodeToken(accessToken);
                    toggleView(true);
                } else {
                    errorElement.textContent = 'B≈Çƒôdny login lub has≈Ço!';
                }
            } catch (error) {
                errorElement.textContent = 'B≈ÇƒÖd po≈ÇƒÖczenia z serwerem.';
            }
        }

        async function registerUser() {
            const data = {
                username: document.getElementById('reg-username').value,
                email: document.getElementById('reg-email').value,
                password: document.getElementById('reg-password').value,
            };
            const errorElement = document.getElementById('register-error');
            errorElement.textContent = '';
            document.getElementById('register-success').textContent = '';

            try {
                const response = await fetch('/api/users/register/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.status === 201) {
                    document.getElementById('register-success').textContent = 'Rejestracja udana! Mo≈ºesz siƒô zalogowaƒá.';
                    new bootstrap.Tab(document.getElementById('login-tab')).show();
                } else {
                    const errorData = await response.json();
                    errorElement.textContent = 'B≈ÇƒÖd rejestracji: ' + JSON.stringify(errorData);
                }
            } catch (error) {
                errorElement.textContent = 'B≈ÇƒÖd po≈ÇƒÖczenia z serwerem.';
            }
        }

        function logout() {
            accessToken = null;
            refreshToken = null;
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            toggleView(false);
        }

        async function refreshAccessToken() {
            if (!refreshToken) return false;

            try {
                const response = await fetch('/api/users/token/refresh/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh: refreshToken })
                });

                if (response.ok) {
                    const tokenData = await response.json();
                    accessToken = tokenData.access;
                    localStorage.setItem('access_token', accessToken);
                    decodeToken(accessToken);
                    return true;
                }
            } catch (e) {
                console.error("B≈ÇƒÖd od≈õwie≈ºania tokenu:", e);
            }
            return false;
        }

        // --- LOGIKA PLIK√ìW (CRUD) ---
        async function loadFiles() {
            if (!accessToken) return toggleView(false);

            const listElement = document.getElementById('file-list');
            const loadingElement = document.getElementById('loading-files');
            const noFilesElement = document.getElementById('no-files-msg');

            if (!listElement || !loadingElement || !noFilesElement) {
                console.error("Krytyczny b≈ÇƒÖd DOM: Nie znaleziono kluczowych kontener√≥w. Przerwano ≈Çadowanie.");
                return;
            }

            const sortValue = document.getElementById('sort-select').value;
            const userFilter = document.getElementById('user-filter').value;
            let url = '/api/files/';
            let params = [];

            if (isAdmin) {
                params.push('all_files=true');
                if (userFilter) {
                    params.push(`owner_username=${userFilter}`);
                    document.getElementById('files-owner-info').textContent = `U≈ºytkownika: ${userFilter}`;
                } else {
                    document.getElementById('files-owner-info').textContent = `WSZYSTKICH U≈ªYTKOWNIK√ìW`;
                }
            } else {
                document.getElementById('files-owner-info').textContent = `Twoje`;
            }

            params.push(`ordering=${sortValue}`);
            if (params.length > 0) {
                url += '?' + params.join('&');
            }

            listElement.innerHTML = '';
            loadingElement.classList.remove('d-none');
            noFilesElement.classList.add('d-none');

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    if (await refreshAccessToken()) return loadFiles();
                    return toggleView(false);
                }

                const files = await response.json();
                loadingElement.classList.add('d-none');
                listElement.innerHTML = '';

                if (files.length === 0) {
                    noFilesElement.classList.remove('d-none');
                } else {
                    files.forEach(file => {
                        const ownerInfo = (isAdmin) ? `${file.owner_username || file.owner}` : '';
                        const fileSizeKB = (file.file_size / 1024).toFixed(2);
                        listElement.innerHTML += `
                            <div class="file-list-item card mb-2 p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>üìÑ <span id="filename-${file.id}">${file.original_filename}</span></strong> 
                                        ${ownerInfo ? `<span class="badge bg-secondary">${ownerInfo}</span>` : ''}
                                        <br>
                                        <small class="text-muted">${file.description || 'Brak opisu'}</small>
                                        <br>
                                        <small class="text-info">Rozmiar: ${fileSizeKB} KB | Wgrano: ${new Date(file.uploaded_at).toLocaleString('pl-PL')}</small>
                                    </div>
                                    <div class="btn-group" role="group">
                                        <a href="${file.file_url}" class="btn btn-sm btn-outline-info" download>‚¨áÔ∏è Pobierz</a>
                                        <button class="btn btn-sm btn-outline-warning" onclick="renameFile(${file.id}, '${file.original_filename.replace(/'/g, "\\'")}')">‚úèÔ∏è Zmie≈Ñ nazwƒô</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteFile(${file.id})">üóëÔ∏è Usu≈Ñ</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
            } catch (error) {
                loadingElement.classList.add('d-none');
                console.error('B≈ÇƒÖd ≈Çadowania plik√≥w:', error);
                listElement.innerHTML = '<div class="alert alert-danger">B≈ÇƒÖd ≈Çadowania plik√≥w.</div>';
            }
        }

        async function uploadFiles() {
            const fileInput = document.getElementById('file-input');
            const descriptionInput = document.getElementById('file-description');
            const statusElement = document.getElementById('upload-status');

            if (!fileInput.files.length) {
                statusElement.innerHTML = '<div class="alert alert-warning">Wybierz przynajmniej jeden plik!</div>';
                return;
            }

            const files = Array.from(fileInput.files);
            const totalFiles = files.length;
            let successCount = 0;
            let failCount = 0;

            statusElement.innerHTML = `<div class="spinner-border spinner-border-sm text-primary" role="status"></div> Wysy≈Çanie ${totalFiles} plik(√≥w)...`;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('description', descriptionInput.value);

                try {
                    const response = await fetch('/api/files/', {
                        method: 'POST',
                        headers: getAuthHeaders(null),
                        body: formData
                    });

                    if (response.status === 401) {
                        if (await refreshAccessToken()) {
                            i--; // Pon√≥w pr√≥bƒô dla tego pliku
                            continue;
                        }
                        statusElement.innerHTML = '<div class="alert alert-danger">‚ùå Sesja wygas≈Ça. Zaloguj siƒô ponownie.</div>';
                        return toggleView(false);
                    }

                    if (response.status === 201) {
                        successCount++;
                        statusElement.innerHTML = `<div class="spinner-border spinner-border-sm text-primary" role="status"></div> Wys≈Çano ${successCount}/${totalFiles} plik√≥w...`;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                }
            }

            // Podsumowanie
            if (failCount === 0) {
                statusElement.innerHTML = `<div class="alert alert-success">‚úÖ Wszystkie pliki wgrane pomy≈õlnie! (${successCount}/${totalFiles})</div>`;
            } else if (successCount === 0) {
                statusElement.innerHTML = `<div class="alert alert-danger">‚ùå Nie uda≈Ço siƒô wgraƒá ≈ºadnego pliku.</div>`;
            } else {
                statusElement.innerHTML = `<div class="alert alert-warning">‚ö†Ô∏è Wgrano ${successCount} z ${totalFiles} plik√≥w. ${failCount} nie powiod≈Ço siƒô.</div>`;
            }

            fileInput.value = '';
            descriptionInput.value = '';
            document.getElementById('file-count').textContent = '0';
            loadFiles();
        }

        async function deleteFile(fileId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten plik?')) return;

            try {
                const response = await fetch(`/api/files/${fileId}/`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    if (await refreshAccessToken()) return deleteFile(fileId);
                    return toggleView(false);
                }

                if (response.status === 204) {
                    alert('‚úÖ Plik usuniƒôty!');
                    loadFiles();
                } else {
                    alert('‚ùå Nie uda≈Ço siƒô usunƒÖƒá pliku.');
                }
            } catch (error) {
                alert('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z serwerem.');
            }
        }

        async function renameFile(fileId, currentName) {
            const newName = prompt('Podaj nowƒÖ nazwƒô pliku:', currentName);
            
            if (!newName || newName.trim() === '') {
                return; // Anulowano lub pusta nazwa
            }

            if (newName === currentName) {
                alert('‚ÑπÔ∏è Nazwa jest taka sama.');
                return;
            }

            try {
                const response = await fetch(`/api/files/${fileId}/rename/`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ new_filename: newName.trim() })
                });

                if (response.status === 401) {
                    if (await refreshAccessToken()) return renameFile(fileId, currentName);
                    return toggleView(false);
                }

                if (response.ok) {
                    const updatedFile = await response.json();
                    alert(`‚úÖ Nazwa zmieniona na: ${updatedFile.original_filename}`);
                    
                    // Aktualizuj nazwƒô w interfejsie bez prze≈Çadowywania ca≈Çej listy
                    const filenameElement = document.getElementById(`filename-${fileId}`);
                    if (filenameElement) {
                        filenameElement.textContent = updatedFile.original_filename;
                    }
                    
                    // Opcjonalnie prze≈Çaduj ca≈ÇƒÖ listƒô dla pewno≈õci
                    loadFiles();
                } else {
                    const errorData = await response.json();
                    alert(`‚ùå B≈ÇƒÖd zmiany nazwy: ${errorData.error || JSON.stringify(errorData)}`);
                }
            } catch (error) {
                console.error('B≈ÇƒÖd zmiany nazwy:', error);
                alert('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z serwerem.');
            }
        }

        // Inicjalizacja przy starcie
        window.addEventListener('DOMContentLoaded', () => {
            // Inicjalizacja autoryzacji
            if (accessToken) {
                decodeToken(accessToken);
                toggleView(true);
            } else {
                toggleView(false);
            }

            // Licznik wybranych plik√≥w
            const fileInput = document.getElementById('file-input');
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    const count = e.target.files.length;
                    document.getElementById('file-count').textContent = count;
                });
            }
        });
    </script>
</body>
</html>
